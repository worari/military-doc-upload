<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเสนอขอ พ.ส.ร. ครบวงจร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-5 rounded-lg flex flex-col items-center">
            <div class="spinner mb-2"></div>
            <p id="loading-text">กำลังประมวลผล...</p>
        </div>
    </div>

    <!-- Login -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center page-section active">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border-t-4 border-green-600">
            <h2 class="text-2xl font-bold text-center mb-6 text-green-800">ระบบเสนอขอ พ.ส.ร.</h2>
            <div id="login-box">
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4"><label class="block mb-2">ชื่อผู้ใช้งาน</label><input type="text" id="username" class="w-full p-2 border rounded" required></div>
                    <div class="mb-6"><label class="block mb-2">รหัสผ่าน</label><input type="password" id="password" class="w-full p-2 border rounded" required></div>
                    <button type="submit" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">เข้าสู่ระบบ</button>
                </form>
                <p class="mt-4 text-center text-sm">ยังไม่มีบัญชี? <a href="#" onclick="toggleAuth('register')" class="text-blue-600">ลงทะเบียน</a></p>
            </div>
            
            <div id="register-box" class="hidden">
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="mb-3"><label class="block">ชื่อ-สกุล (ยศ ชื่อ สกุล)</label><input type="text" name="reg_name" class="w-full p-2 border rounded" required></div>
                    <div class="mb-3"><label class="block">ชื่อผู้ใช้งาน</label><input type="text" name="reg_username" class="w-full p-2 border rounded" required></div>
                    <div class="mb-3"><label class="block">รหัสผ่าน</label><input type="password" name="reg_password" class="w-full p-2 border rounded" required></div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">ลงทะเบียน</button>
                </form>
                <p class="mt-4 text-center text-sm">มีบัญชีแล้ว? <a href="#" onclick="toggleAuth('login')" class="text-green-600">เข้าสู่ระบบ</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Structure -->
    <div id="app-section" class="min-h-screen flex flex-col page-section">
        <nav class="bg-green-700 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20">
            <div class="font-bold text-lg md:text-xl"><i class="fas fa-shield-alt mr-2"></i>ระบบ พ.ส.ร. Online</div>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-sm hidden md:inline">User: -</span>
                <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded text-sm hover:bg-red-600">ออก</button>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white shadow-md hidden md:block z-10 overflow-y-auto">
                <ul class="p-4 space-y-2">
                    <li><button onclick="showPage('dashboard')" class="sidebar-btn w-full text-left p-2 rounded hover:bg-green-50 text-gray-700 font-medium"><i class="fas fa-chart-line w-6"></i> แดชบอร์ด</button></li>
                    <li><button onclick="resetAndShowForm()" class="sidebar-btn w-full text-left p-2 rounded hover:bg-green-50 text-gray-700 font-medium"><i class="fas fa-plus-circle w-6"></i> ยื่นคำร้องใหม่</button></li>
                    <li><button onclick="showPage('tracking')" class="sidebar-btn w-full text-left p-2 rounded hover:bg-green-50 text-gray-700 font-medium"><i class="fas fa-list w-6"></i> ติดตาม/แก้ไข</button></li>
                    <li id="admin-menu" class="hidden"><button onclick="showPage('admin')" class="sidebar-btn w-full text-left p-2 rounded hover:bg-green-50 text-red-600 font-medium"><i class="fas fa-cogs w-6"></i> สำหรับเจ้าหน้าที่</button></li>
                </ul>
            </aside>

            <main class="flex-1 p-4 md:p-6 overflow-y-auto bg-gray-50">
                
                <!-- Dashboard -->
                <div id="view-dashboard" class="content-view">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ภาพรวมสถานการณ์</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500"><h3>คำร้องทั้งหมด</h3><p id="stat-total" class="text-2xl font-bold">0</p></div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500"><h3>รอตรวจสอบ</h3><p id="stat-pending" class="text-2xl font-bold">0</p></div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-green-500"><h3>อนุมัติแล้ว</h3><p id="stat-approved" class="text-2xl font-bold">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-2">แผนที่จุดเกิดเหตุ</h3><div id="map" class="h-80 w-full rounded z-0"></div></div>
                        <div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-2">สถิติเหตุการณ์</h3><canvas id="incidentChart"></canvas></div>
                    </div>
                </div>

                <!-- Form -->
                <div id="view-form" class="content-view hidden">
                    <div class="bg-white p-6 rounded shadow-lg max-w-5xl mx-auto">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2">แบบฟอร์มเสนอขอ พ.ส.ร.</h2>
                        <form id="psrForm" onsubmit="submitPsr(event)">
                            <input type="hidden" name="request_id" id="request_id">
                            
                            <!-- ข้อมูลส่วนตัว -->
                            <div class="bg-gray-50 p-4 rounded mb-4">
                                <h3 class="text-green-700 font-semibold mb-2">ข้อมูลผู้ยื่น</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" name="citizen_id" id="f_citizen_id" placeholder="เลข ปชช." class="p-2 border rounded" required>
                                    <input type="text" name="mil_id" id="f_mil_id" placeholder="เลขทหาร" class="p-2 border rounded" required>
                                    <input type="text" name="rank" id="f_rank" placeholder="ยศ" class="p-2 border rounded" required>
                                    <input type="text" name="firstname" id="f_firstname" placeholder="ชื่อ" class="p-2 border rounded" required>
                                    <input type="text" name="lastname" id="f_lastname" placeholder="สกุล" class="p-2 border rounded" required>
                                    <input type="text" name="position" id="f_position" placeholder="ตำแหน่ง" class="p-2 border rounded" required>
                                    <input type="text" name="unit" id="f_unit" placeholder="สังกัด" class="p-2 border rounded md:col-span-3" required>
                                </div>
                            </div>

                            <!-- เหตุการณ์ -->
                            <div class="bg-gray-50 p-4 rounded mb-4">
                                <h3 class="text-green-700 font-semibold mb-2">ข้อมูลเหตุการณ์</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm">วันเวลา</label>
                                        <input type="datetime-local" name="event_datetime" id="f_event_datetime" class="w-full p-2 border rounded" required>
                                    </div>
                                    <div>
                                        <label class="text-sm">พิกัด (คลิกบนแผนที่)</label>
                                        <div class="flex gap-2">
                                            <input type="text" name="lat" id="input_lat" placeholder="Lat" class="p-2 border rounded w-1/3" readonly>
                                            <input type="text" name="lng" id="input_lng" placeholder="Lng" class="p-2 border rounded w-1/3" readonly>
                                            <input type="text" name="mgrs" id="input_mgrs" placeholder="MGRS" class="p-2 border rounded w-1/3">
                                        </div>
                                    </div>
                                    <div class="col-span-2">
                                        <div id="map-picker" class="h-48 w-full rounded border z-0"></div>
                                    </div>
                                    <textarea name="location_detail" id="f_location_detail" placeholder="สถานที่เกิดเหตุ" class="w-full p-2 border rounded h-16" required></textarea>
                                    <select name="behavior" id="f_behavior" class="p-2 border rounded" required>
                                        <option value="">-- พฤติกรรม --</option>
                                        <option>ปะทะ/ยิงต่อสู้</option>
                                        <option>ลาดตระเวน/ไม่ปะทะ</option>
                                        <option>เหยียบกับระเบิด</option>
                                        <option>ถูกซุ่มโจมตี</option>
                                    </select>
                                    <select name="opponent" id="f_opponent" class="p-2 border rounded" required>
                                        <option value="">-- คู่กรณี --</option>
                                        <option>ข้าศึก</option>
                                        <option>ไม่มีข้าศึก</option>
                                    </select>
                                    <textarea name="outcome" id="f_outcome" placeholder="ผลการปฏิบัติ" class="w-full p-2 border rounded h-16" required></textarea>
                                </div>
                            </div>

                            <!-- เอกสารแนบ -->
                            <div class="bg-gray-50 p-4 rounded mb-4">
                                <h3 class="text-green-700 font-semibold mb-2">อัปโหลดเอกสาร</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div class="border p-2 bg-white rounded"><label>1. กพ.4</label><input type="file" id="file_casualty"><input type="hidden" name="url_casualty" id="url_casualty"></div>
                                    <div class="border p-2 bg-white rounded"><label>2. คำสั่งหน้าที่</label><input type="file" id="file_order"><input type="hidden" name="url_order" id="url_order"></div>
                                    <div class="border p-2 bg-white rounded"><label>3. รับรอง 3 ฝ่าย</label><input type="file" id="file_cert"><input type="hidden" name="url_cert" id="url_cert"></div>
                                    <div class="border p-2 bg-white rounded"><label>4. ใบรับรองแพทย์</label><input type="file" id="file_medical"><input type="hidden" name="url_medical" id="url_medical"></div>
                                    <div class="border p-2 bg-white rounded"><label>5. คำสั่ง พ.ส.ร.</label><input type="file" id="file_psr"><input type="hidden" name="url_psr" id="url_psr"></div>
                                    <div class="border p-2 bg-white rounded"><label>6. อื่นๆ</label><input type="file" id="file_other"><input type="hidden" name="url_other" id="url_other"></div>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded shadow hover:bg-green-700">บันทึกข้อมูล</button>
                        </form>
                    </div>
                </div>

                <!-- Tracking -->
                <div id="view-tracking" class="content-view hidden">
                    <h2 class="text-2xl font-bold mb-4">รายการคำร้อง</h2>
                    <div class="bg-white rounded shadow overflow-x-auto p-4">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100 border-b">
                                <tr><th class="px-4 py-3">วันที่</th><th class="px-4 py-3">รายละเอียด</th><th class="px-4 py-3">สถานะ</th><th class="px-4 py-3">จัดการ</th></tr>
                            </thead>
                            <tbody id="tracking-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin -->
                <div id="view-admin" class="content-view hidden">
                    <h2 class="text-2xl font-bold mb-4 text-red-600">Admin Panel</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-4 rounded shadow">
                            <h3 class="font-bold mb-2">อนุมัติผู้ใช้ใหม่</h3>
                            <div id="admin-user-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold mb-2">จัดการคำร้อง</h3>
                        <table class="min-w-full text-sm"><tbody id="admin-request-table"></tbody></table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        let currentUser = null;
        let map, pickerMap, marker;
        let dashboardChart;
        let allRequests = [];

        // Utility
        const readFile = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve({ data: e.target.result, name: file.name, type: file.type });
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        function toggleLoading(show, text="กำลังประมวลผล...") {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('loading-text').innerText = text;
        }

        // Auth
        function toggleAuth(mode) {
            document.getElementById('login-box').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-box').classList.toggle('hidden', mode !== 'register');
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            toggleLoading(true, "ตรวจสอบข้อมูล...");
            
            google.script.run
                .withSuccessHandler(res => {
                    toggleLoading(false);
                    if (res.status) {
                        currentUser = res.user;
                        enterApp();
                    } else {
                        alert(res.message);
                    }
                })
                .withFailureHandler(error => {
                    toggleLoading(false);
                    alert("Error: " + error.message);
                })
                .loginUser(u, p);
        }

        function handleRegister(e) {
            e.preventDefault();
            const form = document.getElementById('registerForm');
            toggleLoading(true);
            google.script.run.withSuccessHandler(res => {
                toggleLoading(false);
                alert(res.message);
                if (res.status) toggleAuth('login');
            }).registerUser({
                reg_name: form.reg_name.value,
                reg_username: form.reg_username.value,
                reg_password: form.reg_password.value
            });
        }

        function enterApp() {
            document.getElementById('auth-section').classList.remove('active');
            document.getElementById('app-section').classList.add('active');
            document.getElementById('user-display').innerText = `${currentUser.name} (${currentUser.role})`;
            if (['Admin', 'Checker', 'Approver'].includes(currentUser.role)) {
                document.getElementById('admin-menu').classList.remove('hidden');
            }
            initMaps();
            loadDashboard();
        }

        function logout() { location.reload(); }

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${pageId}`).classList.remove('hidden');
            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'tracking') loadTracking();
            if (pageId === 'admin') loadAdmin();
            setTimeout(() => { if (map) map.invalidateSize(); if (pickerMap) pickerMap.invalidateSize(); }, 200);
        }

        // Logic
        function initMaps() {
            if(!map) {
                map = L.map('map').setView([13.736717, 100.523186], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            if(!pickerMap) {
                pickerMap = L.map('map-picker').setView([13.736717, 100.523186], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
                pickerMap.on('click', function(e) {
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    if (marker) pickerMap.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(pickerMap);
                    document.getElementById('input_lat').value = lat;
                    document.getElementById('input_lng').value = lng;
                });
            }
        }

        function resetAndShowForm() {
            document.getElementById('psrForm').reset();
            document.getElementById('request_id').value = "";
            if (marker) pickerMap.removeLayer(marker);
            showPage('form');
        }

        async function submitPsr(e) {
            e.preventDefault();
            toggleLoading(true, "อัปโหลดและบันทึก...");
            const form = document.getElementById('psrForm');
            const fileInputs = ['casualty', 'order', 'cert', 'medical', 'psr', 'other'];
            const formData = {};
            new FormData(form).forEach((value, key) => formData[key] = value);

            try {
                for (const key of fileInputs) {
                    const fileInput = document.getElementById('file_' + key);
                    if (fileInput.files.length > 0) {
                        const fileData = await readFile(fileInput.files[0]);
                        const url = await new Promise((resolve) => {
                            google.script.run.withSuccessHandler(resolve).uploadFileToDrive(fileData.data, fileData.name);
                        });
                        formData['url_' + key] = url;
                    }
                }
                google.script.run.withSuccessHandler(res => {
                    toggleLoading(false);
                    alert(res.message);
                    if (res.status) { form.reset(); showPage('tracking'); }
                }).submitRequest(formData, currentUser);
            } catch (err) {
                toggleLoading(false);
                alert("Upload Error: " + err);
            }
        }

        // Loaders
        function loadDashboard() {
            google.script.run.withSuccessHandler(res => {
                const { stats, rawData } = res;
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-pending').innerText = stats.pending;
                document.getElementById('stat-approved').innerText = stats.approved;
                
                const ctx = document.getElementById('incidentChart').getContext('2d');
                if (dashboardChart) dashboardChart.destroy();
                dashboardChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats.behaviorCounts),
                        datasets: [{ data: Object.values(stats.behaviorCounts), backgroundColor: ['#F87171', '#60A5FA', '#34D399'] }]
                    }
                });
            }).getDashboardStats();
        }

        function loadTracking() {
            google.script.run.withSuccessHandler(data => {
                allRequests = data;
                const tbody = document.getElementById('tracking-table-body');
                tbody.innerHTML = '';
                data.forEach(row => {
                    const date = new Date(row[10]).toLocaleDateString('th-TH');
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3">${date}</td>
                            <td class="px-4 py-3">${row[14]}<br><span class="text-xs text-gray-500">${row[15]}</span></td>
                            <td class="px-4 py-3 font-bold text-blue-600">${row[9]}</td>
                            <td class="px-4 py-3"><button onclick="editRequest('${row[0]}')" class="text-orange-500">แก้ไข</button></td>
                        </tr>`;
                });
            }).getRequests(currentUser);
        }

        function editRequest(id) {
            const req = allRequests.find(r => r[0] == id);
            if (!req) return;
            resetAndShowForm();
            document.getElementById('request_id').value = req[0];
            document.getElementById('f_citizen_id').value = req[2];
            document.getElementById('f_rank').value = req[3];
            document.getElementById('f_firstname').value = req[4];
            document.getElementById('f_lastname').value = req[5];
            document.getElementById('f_mil_id').value = req[6];
            document.getElementById('f_position').value = req[7];
            document.getElementById('f_unit').value = req[8];
            const d = new Date(req[10]);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('f_event_datetime').value = d.toISOString().slice(0, 16);
            document.getElementById('f_location_detail').value = req[14];
            // ... (populate other fields as needed)
        }

        function loadAdmin() {
            if (!['Admin', 'Checker', 'Approver'].includes(currentUser.role)) return;
            google.script.run.withSuccessHandler(users => {
                const container = document.getElementById('admin-user-list');
                container.innerHTML = '';
                users.forEach(u => {
                    if (u[4] === 'Pending') {
                        container.innerHTML += `<div class="flex justify-between p-2 border bg-gray-50"><span>${u[2]}</span><div><button onclick="approveUser('${u[0]}','User')" class="bg-blue-500 text-white px-2 rounded">อนุมัติ</button></div></div>`;
                    }
                });
            }).getUserList();
            
            google.script.run.withSuccessHandler(reqs => {
                const tbody = document.getElementById('admin-request-table');
                tbody.innerHTML = '';
                reqs.forEach(r => {
                    tbody.innerHTML += `<tr class="border-b"><td class="p-2">${r[4]} ${r[5]}</td><td class="p-2">${r[9]}</td><td class="p-2"><button onclick="updateStatus('${r[0]}','อนุมัติ/เสร็จสิ้น')" class="text-green-600">อนุมัติ</button></td></tr>`;
                });
            }).getRequests(currentUser);
        }

        function approveUser(u, r) { google.script.run.withSuccessHandler(()=>loadAdmin()).approveUserAction(u,r); }
        function updateStatus(id, s) { google.script.run.withSuccessHandler(()=>loadAdmin()).updateRequestStatus(id,s,currentUser); }
    </script>
</body>
</html>
